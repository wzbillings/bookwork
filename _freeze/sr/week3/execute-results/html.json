{
  "hash": "f8b21d8a5dfdb9915e2567f50bd20f8b",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"2023 Homework, week 3\"\ndate: 2023-01-27\n---\n\n\n\n\nThis homework covers the material from Lectures 5 and 6, and the content from\nbook Chapters 5 and 6. The questions are reproduced almost identically from\n[Richard McElreath's original assignment](https://github.com/rmcelreath/stat_rethinking_2023/blob/main/homework/week03.pdf), I did not write them. I only wrote these solutions.\n\nFrom the Homework:\n\n> The problems are based on the same data. The data in `data(foxes)` are 116\nfoxes from 30 different urban groups in Engalnd. These fox groups are like\nstreet gangs. Group size (`groupsize`) varies from 2 to 8 individuals. Each\ngroup maintains its own (almsot exclusive) urban territory. Some territories\nare larger than others. The `area` variable encodes this information. Some\nterritories also have more `avgfood` than others. And food influences the\n`weight` of each fox. Assume this DAG:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dagitty)\ndag <- dagitty::dagitty(\n\t\"dag {\n\t\tA -> F -> G -> W\n\t\tF -> W\n\t}\"\n)\n\n# Specify instructions for plotting the DAG, then do that\ndagitty::coordinates(dag) <-\n\tlist(\n\t\tx = c(A = 2, F = 1, G = 3, W = 2),\n\t\ty = c(A = 1, F = 2, G = 2, W = 3)\n\t)\n\nplot(dag)\n```\n\n::: {.cell-output-display}\n![](week3_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n:::\n\n\n\n\n> where $F$ is `avgfood`, $G$ is `groupsize`, $A$ is `area`, and $W$ is\n`weight`.\n\n\n::: {.callout-note appearance=\"simple\" icon=false}\n\n**1.** Use the backdoor criterion and estimate the total causal influence of\n$A$ on $F$. What effect would increasing the area of\na territory have on the amount of food inside of it?\n\n:::\n\nThere are no confounds and there is in fact nothing else on the causal\npathway from $A$ to $F$. So these are the only two variables that need to\nbe in this model. I'll do a simple linear regression with just some default\npriors to estimate this.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Setup\nlibrary(rethinking)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLoading required package: cmdstanr\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThis is cmdstanr version 0.8.1.9000\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n- CmdStanR documentation and vignettes: mc-stan.org/cmdstanr\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n- CmdStan path: C:/Users/Zane/.cmdstan/cmdstan-2.34.1\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n- CmdStan version: 2.34.1\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nA newer version of CmdStan is available. See ?install_cmdstan() to install it.\nTo disable this check set option or environment variable cmdstanr_no_ver_check=TRUE.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLoading required package: posterior\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThis is posterior version 1.6.0\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'posterior'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:stats':\n\n    mad, sd, var\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:base':\n\n    %in%, match\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLoading required package: parallel\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nrethinking (Version 2.40)\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'rethinking'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following object is masked from 'package:stats':\n\n    rstudent\n```\n\n\n:::\n\n```{.r .cell-code}\ndata(foxes)\n\n# Standardize the variables\nD <-\n\tfoxes |>\n\tdplyr::select(\n\t\tF = avgfood,\n\t\tA = area,\n\t\tW = weight,\n\t\tG = groupsize\n\t) |>\n\tdplyr::mutate(\n\t\tdplyr::across(dplyr::everything(), standardize)\n\t) |>\n\tas.list()\n\n\nset.seed(54564)\n# The model\na_on_f <- rethinking::quap(\n\tflist = alist(\n\t\tF ~ dnorm(mu, sigma),\n\t\tmu <- a + b * A,\n\t\ta ~ dnorm(0, 5),\n\t\tb ~ dnorm(0, 5),\n\t\tsigma ~ dexp(1)\n\t),\n\tdata = D\n)\nrethinking::precis(a_on_f)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n               mean         sd        5.5%      94.5%\na     -5.554240e-09 0.04328528 -0.06917824 0.06917822\nb      8.830368e-01 0.04347305  0.81355842 0.95251509\nsigma  4.662142e-01 0.03051589  0.41744386 0.51498444\n```\n\n\n:::\n:::\n\n\n\n \nSo we see that the estimate of the total causal effect of $A$ on $F$ is\n$0.88$ with an $89\\%$ CI of $0.81$ to $0.95$. Let's plot the distribution\nreally quick just to get a better idea.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(100)\nrethinking::dens(extract.samples(a_on_f)$b, lwd = 3)\n```\n\n::: {.cell-output-display}\n![](week3_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n\n\nThe density is centered around 0.88, with our model identifying a range of\nplausible values for around 0.81 to 0.95. In general, we can observe a\npositive effect of area size on the amount of food available in a territory.\nThis makes sense, because if all of these foxes are from around the same\nregion, there should be a similar amount of food available across the area,\nso increasing the size of the territory increases the amount of available\nfood. This might not have been the case if the foxes were from varying\nenvironments, where a large territory might ne necessary for a fox in a food-poor\nenvironment to have the same food availbility in a food-rich environment.\n\n::: {.callout-note appearance=\"simple\" icon=false}\n\n**2.** Infer the **total** causal effect of adding food $F$ to a territory on\nthe weight $W$ of foxes. Can you calculate the causal effect by simulating an\nintervention on food?\n\n:::\n\nAgain, we don't need to control anything to estimate this total causal effect.\n$G$ is a mediator of the relationship of $F$ on $W$ and $A$ is a cause of $F$\nso we don't need to control for either of these. I'll fit another model\nwith nondescript priors.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(100)\nf_on_w_total <- rethinking::quap(\n\tflist = alist(\n\t\tW ~ dnorm(mu, sigma),\n\t\tmu <- a + bF * F,\n\t\ta ~ dnorm(0, 1),\n\t\tbF ~ dnorm(0, 1),\n\t\tsigma ~ dexp(1)\n\t),\n\tdata = D\n)\nf_on_w_total |> rethinking::coeftab() |> rethinking::coeftab_plot()\n```\n\n::: {.cell-output-display}\n![](week3_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\n\nFrom the model estimates, we can see that, in general, the effect of food\navailibility on fox weight does not seem to be very strong. The point estimate\nis slightly negative, with the credible interval reflecting a wide range of\npotential values of either direction.\n\nNow we can simulate an intervention on the amount of food. That is, we're\nestimating $f(W \\mid \\text{do}(F))$ by simulation. First we will draw the\nDAG for when we $\\text{do}(F)$. In this DAG, we delete all arrows into $F$\n(because we are controlling the value of it).\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndo_f <- dagitty::dagitty(\n\t\"dag {\n\t\tF -> G -> W\n\t\tF -> W\n\t}\"\n)\n\n# Specify instructions for plotting the DAG, then do that\ndagitty::coordinates(do_f) <-\n\tlist(\n\t\tx = c(F = 1, G = 3, W = 2),\n\t\ty = c(F = 2, G = 2, W = 3)\n\t)\n\nplot(do_f)\n```\n\n::: {.cell-output-display}\n![](week3_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n\n\nSince $G$ is a pipe, we can ignore simulating $G$ and instead only simulate $F$.\nWe'll simulate this intervention by controlling for the value of $F$ and using\nthe posterior samples to calculate the values of $W$ for each $F$.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Setup\nN <- 1e3\nset.seed(1234819084)\n\n# Extract the posterior samples\npost <- rethinking::extract.samples(f_on_w_total, n = N)\n\n# Values of F to simulate\nf_vec <- seq(0, 1.5, 0.01)\n\n# Container for results\nout <- matrix(nrow = N, ncol = length(f_vec))\n\n# Simulate the results\nfor (i in 1:length(f_vec)) {\n\tout[, i] <- with(\n\t\tpost,\n\t\trnorm(N, a + bF * f_vec[[i]], sigma)\n\t)\n}\n\n# Summarize the output matrix\nplot(\n\tNULL,\n\txlim = c(0, 1.5), ylim = c(-5, 5),\n\txlab = \"Manipulated F\", ylab = \"Simulated W\"\n)\n\n# for (i in 1:length(f_vec)) {\n# \tlines(x = f_vec, y = out[i, ], col = rethinking::col.alpha(\"black\", 0.05))\n# }\n\nfor (p in c(seq(0.5, 0.9, 0.1), 0.95, 0.99)) {\n\tinterval <- apply(out, 2, rethinking::PI, prob = p)\n\trethinking::shade(interval, f_vec)\n}\n\nlines(\n\tx = f_vec, y = colMeans(out),\n\ttype = \"l\", col = \"black\", lwd = 3,\n)\n```\n\n::: {.cell-output-display}\n![](week3_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n\n::: {.callout-note appearance=\"simple\" icon=false}\n\n**3.** Infer the **direct** causal effect of adding food $F$ to a territory on the weight $W$ of foxes. In light of your estmiates from this problem and the previous one, what do you think is going on with these foxes?\n\n:::\n\nBased on the DAG, to get the direct causal effect of foxes, we also need to stratify by $G$ in our model. So we will fit that model first.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(100)\nf_on_w_direct <- rethinking::quap(\n\tflist = alist(\n\t\tW ~ dnorm(mu, sigma),\n\t\tmu <- a + bF * F + bG * G,\n\t\ta ~ dnorm(0, 5),\n\t\tbF ~ dnorm(0, 5),\n\t\tbG ~ dnorm(0, 5),\n\t\tsigma ~ dexp(1)\n\t),\n\tdata = D,\n\tcontrol = list(maxit = 500)\n)\nf_on_w_direct |> rethinking::coeftab() |> rethinking::coeftab_plot()\n```\n\n::: {.cell-output-display}\n![](week3_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\n\nOK, now let's compare the coefficients of the two models.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrethinking::coeftab(f_on_w_total, f_on_w_direct) |>\n\trethinking::coeftab_plot(pars  = c(\"bF\", \"bG\"))\n```\n\n::: {.cell-output-display}\n![](week3_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n\n\nSo when we only stratify by $F$, we don't see an effect. But when we stratify\nby $F$ and $G$, we see an effect of both variables! The optional problem\nsort of spoiled this, but it seems like the most likely explanation here is\nnegative confounding by an unobserved variable. When we don't control for $G$,\nthe confounder still has a backdoor pathway through to $W$, but when we control\nfor $G$ and $F$ simultaneously, the backdoor path is closed and the effect of\n$U$ will be absorbed into the estimated effects of $F$ and $G$ (as it should\nbe). So this is an example of a masked relationship.\n\n::: {.callout-note appearance=\"simple\" icon=false}\n\n**4.** Suppose there is an unobserved confound that influences $F$ and $G$,\nsaying $\\boxed{U}$. Assuming this is the correct DAG, again estimate both the\ntotal and direct causal effects of $F$ on $W$. What impact does the\nunobserved confound have?\n\n:::\n\nI didn't finish this question because I didn't know how, and apparently it is\na trick question because it is not possible to get the total causal effect of\n$F$ (since $U$ is unobserved). That makes me feel better. We would estimate\nthe direct causal effect of $F$ like we already did under this model.\n\n\n\n<!-- END OF FILE -->\n",
    "supporting": [
      "week3_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}